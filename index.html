<!--Created By Cezary Hanczak-->

<!-- 
3D models:
"Bush" (https://skfb.ly/67rOz) by BaptisteBerard is licensed under Creative Commons Attribution (http://creativecommons.org/licenses/by/4.0/).
"Tree For Games" (https://skfb.ly/6TSvz) by Daniel Gryningstjerna is licensed under Creative Commons Attribution (http://creativecommons.org/licenses/by/4.0/).
Nissan 300ZX - "32" (https://skfb.ly/6oWtK) by ï½ononofu is licensed under Creative Commons Attribution (http://creativecommons.org/licenses/by/4.0/).
-->

<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
    </head>
    <title>Gra</title>
	<style>
		body { margin: 0; padding: 0; font-size: 0; background-color: #bebebe;}
		canvas { width: 100%; height: 100%; }
        #start {font-size:50px; width: 100%; font-family:Arial;display:block;position: absolute; text-align: center;line-height: 1; margin-top: 6%;}
        #scoreboard {font-size:50px; width: 100%; font-family:Arial;display:none;position: absolute; text-align: center;line-height: 1; margin-top: 6%;}

        input[type=button], input[type=submit], input[type=reset] {
        border: none;
        color: white;
        padding: 16px 32px;
        text-decoration: none;
        margin: 4px 2px;
        cursor: pointer;
        }

        table.darkTable {
          font-family: Arial, Helvetica, sans-serif;
          width: 80%;
          margin-left: auto;
          margin-right: auto;
          margin-top: 4%;
          margin-bottom: 4%;
          height: 100%;
          border: 2px solid #000000;
          background-color: #4A4A4A;
          text-align: center;
          border-collapse: collapse;
        }
        table.darkTable td, table.darkTable th {
          border: 2px solid #4A4A4A;
          padding: 3px 1px;
        }
        table.darkTable tbody td {
          font-size: 13px;
          color: #E6E6E6;
          padding: 1%;
        }
        table.darkTable tr:nth-child(even) {
          background: #6D6D6C;
        }
        table.darkTable thead {
          background: #000000;
          border-bottom: 3px solid #000000;
        }
        table.darkTable thead th {
          font-size: 15px;
          padding: 1%;
          font-weight: bold;
          color: #E6E6E6;
          text-align: center;
          border-left: 2px solid #606060;
        }
        table.darkTable thead th:first-child {
          border-left: none;
        }
        
        table.darkTable tfoot td {
          font-size: 12px;
        }

        .css-input { font-size:23px; padding:11px; text-align:center; border-width:16px; border-radius:11px; border-style:inset; background-color:#999999; border-color:#7a7a7a; color:#ffffff; box-shadow: 0px 0px 9px 0px rgba(42,42,42,.70); font-family:monospace;  } 
	    .css-input:focus { outline:none; } 
    </style>
    
    <body>
        <div id="back" style="width: 100%; min-height: 100%; display: block;position: absolute"></div>
        <div class="start" id="start">
            <h2>Start game!</h2>
            <h3>Enter your name:</h3>
            <input id="name" class="css-input" type="text" name="name"><br><br>
            <input onclick="again()" class="css-input" type="button" value="Play!"> 
            <input onclick="f_scoreboard()" class="css-input" type="button" value="Scoreboard"> 
        </div>

        <div class="scoreboard" id="scoreboard">
            <h2>Scoreboard</h2>
            <table class="darkTable">
                <thead>
                <tr>
                <th>Position</th>
                <th>Name</th>
                <th>Highscore</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                <td>1</td><td id="name1place"></td><td id="name1score"></td></tr>
                <tr>
                <td>2</td><td id="name2place"></td><td id="name2score"></td></tr>
                <tr>
                <td>3</td><td id="name3place"></td><td id="name3score"></td></tr>
                <tr>
                <td>4</td><td id="name4place"></td><td id="name4score"></td></tr>
                <tr>
                <td>5</td><td id="name5place"></td><td id="name5score"></td></tr>
                </tbody>
                </tr>
            </table>
            <input onclick="again()" class="css-input" type="button" value="Play!"> 
            <input onclick="main_menu()" class="css-input" type="button" value="Main menu"> 
        </div>

        <div id="level_div" style="font-family:Arial; line-height: 0.1; font-size:70px; position: absolute;top: 40px;width: auto;text-align: center; z-index: 100; display:block; float:left; text-align: left; margin-left: 2%;"><p id="level"></p><p id="points"></p><p id="health"></p></div>

        <script src="js/three.min.js"></script>
        <script src="js/GLTFLoader.js"></script>
        <script src="js/jquery-3.5.1.min.js"></script>
        <script>
            
            var menu = document.getElementById("start");
            var _scoreboard = document.getElementById("scoreboard");
            _scoreboard.style.display = "none";
            
            var background = document.getElementById("back");
            background.style.background = "rgba(150, 150, 150, 0.5)";

            nickname_set = 0;
            var nickname = null;
            var player_id;
            var player_name;
            var player_highscore;

            var speed_x = 0;
	        var speed_z = 0;
	        var act_speed_x = 0;
            var act_speed_z = 0;
            var act_car_rotation = 0;

            var texture_pos = 0;

            var level = 0.04;
            var health = 100;
            var points = 0;
            var level_counter = 1;
            var last_time = (new Date()).getTime();
            var last_time_lvl = (new Date()).getTime();

            var is_bush = 0;
            var bush_cpy = null;
            var is_tree = 0;
            var tree_cpy = null;

            var is_hole1 = 0;
            var hole1_cpy = null;
            var is_hole2 = 0;
            var hole2_cpy = null;
            var is_hole3 = 0;
            var hole3_cpy = null;

            var is_cone1 = 0;
            var cone1_cpy = null;
            var is_cone2 = 0;
            var cone2_cpy = null;
            var is_cone3 = 0;
            var cone3_cpy = null;

            var hole_time = 0;
	    var	cone_time = 0;

            var  curTime = 0;

            document.addEventListener('keydown',onDocumentKeyDown,false);
            document.addEventListener('keyup',onDocumentKeyUp,false);

            function onDocumentKeyDown(event){
            event = event || window.event;
            var keycode = event.keyCode;
            switch(keycode){            
            case 37 :
            	 console.log("left down" );
            	 speed_x = -10;
            	 break;
            case 38 :
            	 console.log("up down"   );
            	 speed_z = 10;
            	 break;
            case 39 :
            	 console.log("right down");
            	 speed_x = 10;
            	 break;
            case 40 :
            	 console.log("down down" );
            	 speed_z = -10;
            	 break;
            }
            }

            function onDocumentKeyUp(event){
            event = event || window.event;
            var keycode = event.keyCode;
            switch(keycode){
            case 37 :
                 console.log("left up" );
                 if(speed_x < 0)
            	    speed_x = 0;
            	 break;
            case 38 :           
                 console.log("up up"   );
                 if(speed_z > 0)
            	    speed_z = 0;
            	 break;
            case 39 :
                 console.log("right up");
                 if(speed_x > 0)
            	    speed_x = 0;
            	 break;
            case 40 :
                 console.log("down up" );
                 if(speed_z < 0)
            	    speed_z = 0;
            	 break;
            }
            }     
            

            scene  = new THREE.Scene();
            scene.background = new THREE.Color(0xdddddd);
            var WIDTH = window.innerWidth;
	        var HEIGHT = window.innerHeight;
            var scene, camera, renderer;
            var car_model = null;
            var road_plane_cpy = null;
            var grass_left_plane_cpy = null;
            var grass_right_plane_cpy = null;
            var health_level_cpy = null;

            function init()
            {

                //road
                var Texture = new THREE.TextureLoader().load( "textures/road1.jpg" ); 
                Texture.wrapT = THREE.RepeatWrapping; 
                Texture.wrapS = THREE.RepeatWrapping; 
            
                Texture.repeat.set( 1, 8 );

                var Material = new THREE.MeshBasicMaterial( { map: Texture, side: THREE.DoubleSide } );
                var Geometry = new THREE.PlaneGeometry(16, 80, 1, 1);
                var road_plane = new THREE.Mesh(Geometry, Material); 
                road_plane.rotation.set(1.57, 0, 0);
                road_plane.material.map.offset.y = 1.5;
                road_plane_cpy = road_plane;
                scene.add(road_plane);


                //grass
                var Texture = new THREE.TextureLoader().load( "textures/grass.jpg" ); 
                Texture.wrapT = THREE.RepeatWrapping; 
                Texture.wrapS = THREE.RepeatWrapping; 
            
                Texture.repeat.set( 10, 10 );

                var Material = new THREE.MeshBasicMaterial( { map: Texture, side: THREE.DoubleSide } );
                var Geometry = new THREE.PlaneGeometry(100, 100, 1, 1);
                var right_grass_plane = new THREE.Mesh(Geometry, Material); 
                right_grass_plane.rotation.set(1.57, 0, 0);
                right_grass_plane.position.set(58,0,0);
                right_grass_plane.material.map.offset.y = 1.5; 
                grass_right_plane_cpy = right_grass_plane;
                scene.add(right_grass_plane);

                var Texture = new THREE.TextureLoader().load( "textures/grass.jpg" ); 
                Texture.wrapT = THREE.RepeatWrapping; 
                Texture.wrapS = THREE.RepeatWrapping; 
            
                Texture.repeat.set( 10, 10 );

                var Material = new THREE.MeshBasicMaterial( { map: Texture, side: THREE.DoubleSide } );
                var Geometry = new THREE.PlaneGeometry(100, 100, 1, 1);
                var left_grass_plane = new THREE.Mesh(Geometry, Material); 
                left_grass_plane.rotation.set(1.57, 0, 0);
                left_grass_plane.position.set(-58,0,0);
                left_grass_plane.material.map.offset.y = 1.5; 
                grass_left_plane_cpy = left_grass_plane;
                scene.add(left_grass_plane);
                
                //health level
                var geometry = new THREE.PlaneGeometry( 21, 2, 1, 1);
                var material = new THREE.MeshBasicMaterial( {color: 0x000000, side: THREE.DoubleSide} );
                var health_level_back = new THREE.Mesh( geometry, material );
                health_level_back.position.set(25,1,0);
                health_level_back.rotation.set(-0.1, 0, 0);
                scene.add( health_level_back );

                var geometry = new THREE.PlaneGeometry( 20, 1, 1, 1);
                var material = new THREE.MeshBasicMaterial( {color: 0xff1111, side: THREE.DoubleSide} );
                var health_level = new THREE.Mesh( geometry, material );
                health_level.position.set(25,1,0.1);
                health_level.rotation.set(-0.1, 0, 0);
                health_level_cpy = health_level;
                scene.add( health_level );

                //camera
                camera = new THREE.PerspectiveCamera(50, WIDTH/HEIGHT, 0.1, 10000);
                camera.position.x = 0;
                camera.position.y = 13;
                camera.position.z = 40;
                camera.rotation.x = -0.6;
                

                //light
                var hlight = new THREE.AmbientLight(0xffe4d6,1.5);
                scene.add(hlight);
                

                renderer = new THREE.WebGLRenderer({antialias:true});
                renderer.setSize(WIDTH, HEIGHT);
                document.body.appendChild(renderer.domElement);

                
                //car
                var loader = new THREE.GLTFLoader();
                loader.load('nissan/scene.gltf', 
                ( gltf ) => 
                {
                    car = gltf.scene.children[0];
                    car_model = car;
                    car.scale.set(0.02,0.02,0.02);
                    car.rotation.z += 3.14;  //turn +left -right
                    car.position.z = 25;    //move +backward -forward
                    car.position.x = 0 ;    //move +right -left
                    scene.add( gltf.scene );
                    renderer.render(scene,camera);
                    //move();
                    
                },           
                );

                console.log("init");
            }
            init();

            
            function move() 
	        {	
            background.style.background = "rgba(150, 150, 150, 0.0)";
            if(nickname_set == 0)
            {
                nickname = document.getElementById("name").value;
                if(nickname == "")
                {
                    alert("You must enter a name");
                    main_menu();
                    nickname_set = 0;
                    return;
                } 
                
                nickname_set = 1;
                //add user to API database                  
                $.ajax({
                url: "https://imsi.pl:5000/players",
                method : "put",
                dataType : "json",
                data: {
                    name : nickname
                },
                success: function(response) 
                {
                    console.log(response);       
                },
                error : function() 
                {
                    alert("Error with API");
                    return;
                },
                });        
            }


            if(menu.style.display != "none")
            {
                menu.style.display = "none";
            }
            if(scoreboard.style.display != "none")
            {
                scoreboard.style.display = "none";
            }
                

	        if(act_speed_x > speed_x)
	        {
            setTimeout(() => {  act_speed_x -= 1; }, 0.01);
	        }
	        if(act_speed_x < speed_x)
	        {
            setTimeout(() => {  act_speed_x += 1; }, 0.01);
	        }
	        if(act_speed_z < speed_z)
	        {
            setTimeout(() => {  act_speed_z += 1; }, 0.01);
	        }
	        if(act_speed_z > speed_z)
	        {
            setTimeout(() => {  act_speed_z -= 1; }, 0.01);
            }

            //car move
            if(car_model.position.x <= 15 && car_model.position.x >= -15)
            {
                car_model.position.x += act_speed_x / 40;
                if(car_model.position.x >= 15) car_model.position.x = 15;
                if(car_model.position.x <= -15) car_model.position.x = -15;
            }

            if(car_model.position.z <= 30 && car_model.position.z >= 0)
            {
                car_model.position.z -= act_speed_z / 40;
                if(car_model.position.z >= 30) car_model.position.z = 30;
                if(car_model.position.z <= 0) car_model.position.z = 0;
            }

            //car turn
            act_car_rotation = act_speed_x / 40;
            car_model.rotation.z = -act_car_rotation + 3.14;

            //motion of grass and road
            texture_pos -= level;
            if(texture_pos < 0) texture_pos = 100;
            road_plane_cpy.material.map.offset.y = texture_pos;
            grass_right_plane_cpy.material.map.offset.y = texture_pos;
            grass_left_plane_cpy.material.map.offset.y = texture_pos;

            //camera shake
            camera.position.x = 0;
            camera.position.y = 13;
            camera.position.z = 40;
            camera.rotation.x = -0.6;
            if(car_model.position.x > 7 || car_model.position.x < -7)
            {            
                camera.position.x += (Math.random() - 0.5) /10;
                camera.position.y += (Math.random() - 0.5) /10;
                camera.position.z += (Math.random() - 0.5) /10;
                health -= (0.5 + (level / 10));
            }

            health_level_cpy.scale.set(health/100, 1, 1);
            health_level_cpy.position.x = 25 + (health-100)/10;

            
            //health, points, level
            if(health <= 0)
            {
                health_level_cpy.scale.set(0, 0, 0);
                document.getElementById("health").innerHTML = "Health: " + 0;
                renderer.render(scene, camera);

                var player = null;

                const _url = "https://imsi.pl:5000/player/" + nickname;
               
                $.ajax({
                    url: _url,
                    method : "get",
                    async: false,
                    dataType : "json",
                    complete: function(response) 
                    {
                        player = jQuery.parseJSON(response.responseText);
                        player_id = player[0].id;
                        player_name = player[0].name;
                        player_highscore = player[0].p1;

                        if(player_highscore < points)
                            player_highscore = points;

                        var update_url = "https://imsi.pl:5000/players/" + player_id;

                        $.ajax({
                            url : update_url,
                            method : "put",
                            dataType : "json",
                            data: {
                                p0 : "HanczakFinal2",
                                p1 : player_highscore
                            },
                            success: function(response) 
                            {
                                console.log("ok");      
                            },
                            error : function() 
                            {
                                alert("Error with API");
                                return;
                            },
                        });
                    }
                });
                f_scoreboard();
                return;
            }
            
            curTime = (new Date()).getTime();
            if(curTime - last_time > 100 - (level * 10))
            {
                points++;
                last_time = (new Date()).getTime();
            }

            if(curTime - last_time_lvl > 1000 * 10)
            {
                points += 100;
                last_time_lvl = (new Date()).getTime();
                level += 0.002;
                console.log(level);
                level_counter++;
            }   

            document.getElementById("level").innerHTML = "Level: " + level_counter;
            document.getElementById("points").innerHTML = "Score: " + points;
            document.getElementById("health").innerHTML = "Health: " + Math.ceil(health);

            //potholes in the road and collisions
            random = Math.random();
            curTime = (new Date()).getTime();
            if(is_hole1 == 0 && random > 0.99 && curTime - hole_time > 20)
            {
                var Texture = new THREE.TextureLoader().load( "textures/hole.png" );  
                var Material = new THREE.MeshBasicMaterial( { map: Texture, side: THREE.DoubleSide,  transparent: true } );
                var Geometry = new THREE.PlaneGeometry(4, 4, 1, 1);
                var hole1_plane = new THREE.Mesh(Geometry, Material); 

                hole1_plane.rotation.set(1.57, 0, 0);
                x_random = Math.random() * 3;
                if(x_random > 2)
                    hole1_plane.position.set(5,0.2,-40);
                else if (x_random > 1)
                    hole1_plane.position.set(0,0.2,-40);
                else
                    hole1_plane.position.set(-5,0.2,-40);
                hole1_cpy = hole1_plane;

                scene.add(hole1_plane);
                is_hole1 = 1;
                hole_time = curTime;

            }

            if(is_hole1 == 1)
            {
                hole1_cpy.position.z += level * 10;    
                if(car_model.position.x + 2 >= hole1_cpy.position.x - 1 && car_model.position.x - 2 <= hole1_cpy.position.x + 1)
                {
                    if(car_model.position.z + 1.5 >= hole1_cpy.position.z - 1 && car_model.position.z - 1.5 <= hole1_cpy.position.z + 1)
                    { 
                           health -= 2;
                           camera.position.x = 0;
                           camera.position.y = 13;

                           camera.position.x += (Math.random() - 0.5) /10;
                           camera.position.y += (Math.random() - 0.5) /10;
                           camera.position.z += (Math.random() - 0.5) /10;
                    }
                }    
                if(hole1_cpy.position.z > 40)
                {
                    is_hole1 = 0;
                    scene.remove(hole1_cpy);
                }     
                            
            }

            random = Math.random();
            curTime = (new Date()).getTime();
            if(is_hole2 == 0 && random > 0.99 && curTime - hole_time > 20)
            {
                var Texture = new THREE.TextureLoader().load( "textures/hole.png" );  
                var Material = new THREE.MeshBasicMaterial( { map: Texture, side: THREE.DoubleSide,  transparent: true } );
                var Geometry = new THREE.PlaneGeometry(4, 4, 1, 1);
                var hole2_plane = new THREE.Mesh(Geometry, Material); 

                hole2_plane.rotation.set(1.57, 0, 0);
                x_random = Math.random() * 3;
                if(x_random > 2)
                    hole2_plane.position.set(5,0.2,-40);
                else if (x_random > 1)
                    hole2_plane.position.set(0,0.2,-40);
                else
                    hole2_plane.position.set(-5,0.2,-40);
                hole2_cpy = hole2_plane;

                scene.add(hole2_plane);
                is_hole2 = 1;
                hole_time = curTime;

            }

            if(is_hole2 == 1)
            {
                hole2_cpy.position.z += level * 10;       
                if(car_model.position.x + 2 >= hole2_cpy.position.x - 1 && car_model.position.x - 2 <= hole2_cpy.position.x + 1)
                {
                    if(car_model.position.z + 1.5 >= hole2_cpy.position.z - 1 && car_model.position.z - 1.5 <= hole2_cpy.position.z + 1)
                    { 
                           health -= 2;
                           camera.position.x = 0;
                           camera.position.y = 13;

                           camera.position.x += (Math.random() - 0.5) /10;
                           camera.position.y += (Math.random() - 0.5) /10;
                           camera.position.z += (Math.random() - 0.5) /10;
                    }
                }   
                if(hole2_cpy.position.z > 40)
                {
                    is_hole2 = 0;
                    scene.remove(hole2_cpy);
                }                 
            }

            random = Math.random();
            curTime = (new Date()).getTime();
            if(is_hole3 == 0 && random > 0.99 && curTime - hole_time > 20)
            {
                var Texture = new THREE.TextureLoader().load( "textures/hole.png" );  
                var Material = new THREE.MeshBasicMaterial( { map: Texture, side: THREE.DoubleSide,  transparent: true } );
                var Geometry = new THREE.PlaneGeometry(4, 4, 1, 1);
                var hole3_plane = new THREE.Mesh(Geometry, Material); 

                hole3_plane.rotation.set(1.57, 0, 0);
                x_random = Math.random() * 3;
                if(x_random > 2)
                    hole3_plane.position.set(5,0.2,-40);
                else if (x_random > 1)
                    hole3_plane.position.set(0,0.2,-40);
                else
                    hole3_plane.position.set(-5,0.2,-40);
                hole3_cpy = hole3_plane;

                scene.add(hole3_plane);
                is_hole3 = 1;
                hole_time = curTime;

            }

	    
            if(is_hole3 == 1)
            {
                hole3_cpy.position.z += level * 10;   
                if(car_model.position.x + 2 >= hole3_cpy.position.x - 1 && car_model.position.x - 2 <= hole3_cpy.position.x + 1)
                {
                    if(car_model.position.z + 1.5 >= hole3_cpy.position.z - 1 && car_model.position.z - 1.5 <= hole3_cpy.position.z + 1)
                    { 
                           health -= 2;
                           camera.position.x = 0;
                           camera.position.y = 13;

                           camera.position.x += (Math.random() - 0.5) /10;
                           camera.position.y += (Math.random() - 0.5) /10;
                           camera.position.z += (Math.random() - 0.5) /10;
                    }
                }       
                if(hole3_cpy.position.z > 40)
                {
                    is_hole3 = 0;
                    scene.remove(hole3_cpy);
                }                 
            }

            //traffic cones and collisions
            random = Math.random();
	    curTime = (new Date()).getTime();
            if(is_cone1 == 0 && random > 0.99 && curTime - cone_time > 25)
            {
                var Texture = new THREE.TextureLoader().load( "textures/bollard.png" );  
                var Material = new THREE.MeshBasicMaterial( { map: Texture, side: THREE.DoubleSide,  transparent: true } );
                var Geometry = new THREE.PlaneGeometry(3, 4, 1, 1);
                var cone1_plane = new THREE.Mesh(Geometry, Material); 

                cone1_plane.rotation.set(2.2, 0, 3.14);
                x_random = Math.random() * 3;
                if(x_random > 2)
                    cone1_plane.position.set(5,0.7,-40);
                else if (x_random > 1)
                    cone1_plane.position.set(0,0.7,-40);
                else
                    cone1_plane.position.set(-5,0.7,-40);
                cone1_cpy = cone1_plane;

                scene.add(cone1_plane);
                is_cone1 = 1;
		cone_time = curTime;

            }

            if(is_cone1 == 1)
            {
                cone1_cpy.position.z += level * 10;    
                if(car_model.position.x + 2 >= cone1_cpy.position.x - 0.6 && car_model.position.x - 2 <= cone1_cpy.position.x + 0.6)
                {
                    if(car_model.position.z + 1.5 >= cone1_cpy.position.z - 0.6 && car_model.position.z - 1.5 <= cone1_cpy.position.z + 0.6)
                    { 
                           health -= 0.7;
                           camera.position.x = 0;
                           camera.position.y = 13;

                           camera.position.x += (Math.random() - 0.5) /10;
                           camera.position.y += (Math.random() - 0.5) /10;
                           camera.position.z += (Math.random() - 0.5) /10;
                    }
                }    
                if(cone1_cpy.position.z > 40)
                {
                    is_cone1 = 0;
                    scene.remove(cone1_cpy);
                }     
                            
            }

            random = Math.random();
	    curTime = (new Date()).getTime();
            if(is_cone2 == 0 && random > 0.99 && curTime - cone_time > 25)
            {
                var Texture = new THREE.TextureLoader().load( "textures/bollard.png" );  
                var Material = new THREE.MeshBasicMaterial( { map: Texture, side: THREE.DoubleSide,  transparent: true } );
                var Geometry = new THREE.PlaneGeometry(3, 4, 1, 1);
                var cone2_plane = new THREE.Mesh(Geometry, Material); 

                cone2_plane.rotation.set(2.2, 0, 3.14);
                x_random = Math.random() * 3;
                if(x_random > 2)
                    cone2_plane.position.set(5,0.7,-40);
                else if (x_random > 1)
                    cone2_plane.position.set(0,0.7,-40);
                else
                    cone2_plane.position.set(-5,0.7,-40);
                cone2_cpy = cone2_plane;

                scene.add(cone2_plane);
                is_cone2 = 1;
		cone_time = curTime;

            }

            if(is_cone2 == 1)
            {
                cone2_cpy.position.z += level * 10;    
                if(car_model.position.x + 2 >= cone2_cpy.position.x - 0.6 && car_model.position.x - 2 <= cone2_cpy.position.x + 0.6)
                {
                    if(car_model.position.z + 1.5 >= cone2_cpy.position.z - 0.6 && car_model.position.z - 1.5 <= cone2_cpy.position.z + 0.6)
                    { 
                           health -= 0.7;
                           camera.position.x = 0;
                           camera.position.y = 13;

                           camera.position.x += (Math.random() - 0.5) /10;
                           camera.position.y += (Math.random() - 0.5) /10;
                           camera.position.z += (Math.random() - 0.5) /10;
                    }
                }    
                if(cone2_cpy.position.z > 40)
                {
                    is_cone2 = 0;
                    scene.remove(cone2_cpy);
                }     
                            
            }

            random = Math.random();
	    curTime = (new Date()).getTime();
            if(is_cone3 == 0 && random > 0.999 && curTime - cone_time > 25)
            {
                var Texture = new THREE.TextureLoader().load( "textures/bollard.png" );  
                var Material = new THREE.MeshBasicMaterial( { map: Texture, side: THREE.DoubleSide,  transparent: true } );
                var Geometry = new THREE.PlaneGeometry(3, 4, 1, 1);
                var cone3_plane = new THREE.Mesh(Geometry, Material); 

                cone3_plane.rotation.set(2.2, 0, 3.14);
                x_random = Math.random() * 3;
                if(x_random > 2)
                    cone3_plane.position.set(5,0.7,-40);
                else if (x_random > 1)
                    cone3_plane.position.set(0,0.7,-40);
                else
                    cone3_plane.position.set(-5,0.7,-40);
                cone3_cpy = cone3_plane;

                scene.add(cone3_plane);
                is_cone3 = 1;
		cone_time = curTime;
            }

            if(is_cone3 == 1)
            {
                cone3_cpy.position.z += level * 10;    
                if(car_model.position.x + 2 >= cone3_cpy.position.x - 0.6 && car_model.position.x - 2 <= cone3_cpy.position.x + 0.6)
                {
                    if(car_model.position.z + 1.5 >= cone3_cpy.position.z - 0.6 && car_model.position.z - 1.5 <= cone3_cpy.position.z + 0.6)
                    { 
                           health -= 0.7;
                           camera.position.x = 0;
                           camera.position.y = 13;

                           camera.position.x += (Math.random() - 0.5) /10;
                           camera.position.y += (Math.random() - 0.5) /10;
                           camera.position.z += (Math.random() - 0.5) /10;
                    }
                }    
                if(cone3_cpy.position.z > 40)
                {
                    is_cone3 = 0;
                    scene.remove(cone3_cpy);
                }     
                            
            }


            //tree spawn
            random = Math.random() ;
            if(random > 0.99)
            {
                if(is_tree == 0)
                {
                    is_tree = 1; 
                    var loader = new THREE.GLTFLoader();
                    loader.load('tree1/scene.gltf', 
                    ( gltf ) => 
                    {
                         tree = gltf.scene.children[0];
                         tree.scale.set(0.008,0.008,0.008);
                         tree.position.set(0,-1,0);
                         tree_cpy = tree;
                         tree.position.z = -38; //motion +backward -forward
                         random = Math.random();
                         if(random > 0.5)
                             tree.position.x =  (Math.random() * 10) + 18 ;
                         else
                             tree.position.x =  (Math.random() * -10) - 18 ;

                         scene.add( gltf.scene );
                    
                    },           
                    );       
                }
                else if(is_tree == 2)
                {
                    is_tree = 1;
                    tree_cpy.position.z = -37;
                    random = Math.random();
                    if(random > 0.5)
                        tree_cpy.position.x =  (Math.random() * 10) + 18 ;
                    else
                        tree_cpy.position.x =  (Math.random() * -10) - 18 ;
                }
                   
            }
            if(is_tree == 1)
            {
                if(tree_cpy) 
                {
                    tree_cpy.position.z += level * 10;

                    if(tree_cpy.position.z > 35 )
                    {
                        is_tree = 2;
                    }          
                }   
            }

            //bush spawn
            random = Math.random();
            if(random > 0.99)
            {
                if(is_bush == 0)
                {
                    is_bush = 1; 
                    var loader = new THREE.GLTFLoader();
                    loader.load('bush2/scene.gltf', 
                    ( gltf ) => 
                    {
                        bush = gltf.scene.children[0];
                        bush.scale.set(1.3,1.3,1.3);
                        bush.position.set(0,5.5,0);
                        bush_cpy = bush;
                        bush.position.z = -35; //pozycja +backward -forward
                        random = Math.random();
                       
                        if(random > 0.5)
                            bush.position.x =  (Math.random() * 10) + 18 ;
                        else
                            bush.position.x =  (Math.random() * -10) - 18 ;

                        scene.add( gltf.scene );
                    
                    },           
                    );       
                }
                else if(is_bush == 2)
                {
                    is_bush = 1;
                    bush_cpy.position.z = -35;
                    random = Math.random();
                    if(random > 0.5)
                        bush_cpy.position.x =  (Math.random() * 13) + 18 ;
                    else
                        bush_cpy.position.x =  (Math.random() * -13) - 18 ;
                }
                   
            }
            if(is_bush == 1)
            {
                if(bush_cpy) 
                {
                    bush_cpy.position.z += level * 10;
                    if(bush_cpy.position.z > 35 )
                    {
                        is_bush = 2;
                    }          
                }   
            }
            
            //animation
	        requestAnimationFrame(move);
            renderer.render(scene, camera);
            
        }HanczakFinal2

        //scoreboard display
        function f_scoreboard()
        {
            background.style.background = "rgba(150, 150, 150, 0.5)";
            if(menu.style.display != "none")
            {
                menu.style.display = "none";
            }
            if(_scoreboard.style.display === "none")
            {
                _scoreboard.style.display = "block";
            }    

            
            var _url = "https://nowa.imsi.pl:5000/players/" + "HanczakFinal2";
            $.ajax({
                url: _url,
                method : "get",
                async: false,
                dataType : "json",
                complete: function(response) 
                {
                    player = jQuery.parseJSON(response.responseText);
                    var best = [];
                    for(var i = 0; player[i]; i++)
                    {
                        best[i] = player[i].p1;
                    }
                    best.sort(function(a, b) {return b - a;});
                    console.log(player);
                    for(var i = 0; i < 5; i++)
                    {
                        var temp1 = "name" + (i + 1) + "place";
                        var temp2 = "name" + (i + 1) + "score";
                        document.getElementById(temp1).innerHTML = "...";
                        document.getElementById(temp2).innerHTML = "...";
                        for(var k = 0; player[k]; k++)
                        {
                            if(best[i] == player[k].p1)
                            {
                                document.getElementById(temp1).innerHTML = player[k].name;
                                document.getElementById(temp2).innerHTML = player[k].p1;
                            }
                        }   
                    }
                    
                },
                error : function() 
                {
                        alert("Error with API");
                        return;
                },
            });
            
        }

        //menu display
        function main_menu()
        {
            background.style.background = "rgba(150, 150, 150, 0.5)";
            if(scoreboard.style.display != "none")
            {
                _scoreboard.style.display = "none";
            }
            if(menu.style.display === "none")
            {
                menu.style.display = "block";
            }
        }

        //start and play again
        function again()
        {
        
            level = 0.04;
            health = 100;
            points = 0;
            level_counter = 1;

            if(car_model)
            {
                car_model.position.z = 25;
                car_model.position.x = 0;
            }

            if(cone1_cpy)
            {
                is_cone1 = 0;
                scene.remove(cone1_cpy);
            } 
            if(cone2_cpy)
            {
                is_cone2 = 0;
                scene.remove(cone2_cpy);
            } 
            if(cone2_cpy)
            {
                is_cone2 = 0;
                scene.remove(cone2_cpy);
            } 

            
            if(hole1_cpy)
            {
                is_hole1 = 0;
                scene.remove(hole1_cpy);
            } 
            if(hole2_cpy)
            {
                is_hole2 = 0;
                scene.remove(hole2_cpy);
            } 
            if(hole3_cpy)
            {
                is_hole3 = 0;
                scene.remove(hole3_cpy);
            } 
            last_time_lvl = (new Date()).getTime();
            move();
        }

        </script>

    </body>
</html>
